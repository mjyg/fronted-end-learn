#!/usr/bin/env node
const { program } = require('commander');
const figlet = require('figlet');
const versionStr = figlet.textSync('YiDeng');
const Printer = require('@darkobits/lolcatjs');
const shell = require('shelljs');
let json2ts = require('json2ts');
const _version = require('../package.json').version;
const chalk = require('chalk');
const inquirer = require('inquirer');
const ora = require('ora');
const download = require('download-git-repo');
program.version(
  Printer.default.fromString(
    `   \n      äº¬ç¨‹ä¸€ç¯è„šæ‰‹æ¶${_version}\n    www.yidengxuetang.com \n${versionStr}`
  )
);
program.option('-c,create', 'åˆå§‹åŒ–é¡¹ç›®ğŸ˜');
program.option('-j,json2ts', 'ç”ŸæˆTypeScriptğŸ»');
const bindHandler = {
  create(otherParmas) {
    inquirer
      .prompt([
        {
          type: 'text',
          message: 'â‘  ğŸ’Œ è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°',
          name: 'dirname',
        },
        {
          type: 'list',
          name: 'jskind',
          message: 'â‘¡ è¯·é€‰æ‹©å¼€å‘è¯­è¨€',
          choices: ['â˜‰ TypeScript', 'â˜‰ EcmaScript6'],
        },
      ])
      .then((answers) => {
        // console.log(answers.dirname);
        const _pwd = shell.pwd().stdout;
        const projectPath = `${_pwd}/${answers.dirname}`;
        // console.log('ç”¨æˆ·çš„å…¨è·¯å¾„', projectPath, answers.jskind);
        shell.rm('-rf', projectPath);
        shell.mkdir(projectPath);
        const spinner = ora('â° downloading template.....');
        spinner.start();
        const template =
          'direct:https://github.com/lgwebdream/yd-vue-kernel.git';
        download(template, projectPath, { clone: true }, function (err) {
          spinner.stop();
          if (err) {
            console.log(chalk.red('ä¸‹è½½å¤±è´¥ğŸ˜­'));
          } else {
            shell.sed(
              '-i',
              'yd-vue-kernel',
              answers.dirname,
              projectPath + '/package.json'
            );
          }
        });
      });
  },
  json2ts(url) {
    const data = {
      yideng: 'laoyuan',
      data: {
        age: 30 || '',
      },
    };
    const jsonContent = JSON.stringify(data);
    let result = json2ts.convert(jsonContent);
    console.log(result);
  },
};
program
  .usage('[cmd] <options>')
  .arguments('<cmd> [env]')
  .action(function (cmd, otherParmas) {
    const handler = bindHandler[cmd];
    if (typeof handler === 'undefined') {
      console.log(chalk.blue(`${cmd}`) + chalk.red('æš‚æœªæ”¯æŒ'));
    } else {
      handler(otherParmas);
    }
    // console.log('cmd', cmd);
    // console.log('otherParmas', otherParmas);
  });
program.parse(process.argv);
